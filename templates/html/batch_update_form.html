{% extends "base.html" %}

{% block title %}Массовое обновление - MikroTik Manager{% endblock %}



{% block page_actions %}
    <div class="page-actions">
        {% if devices %}
        <button type="submit" form="updateForm" class="btn-unified btn-warning">
            <i class="fas fa-play"></i> Продолжить
        </button>
        {% endif %}
        <a href="{{ url_for('devices') }}" class="btn-unified btn-secondary">
            <i class="fas fa-arrow-left"></i> Назад
        </a>
    </div>
{% endblock %}

{% block content %}
{% if not devices %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-info-circle fa-4x"></i>
            </div>
            <h5>Нет устройств для обновления</h5>
            <p class="text-muted">В настоящее время нет устройств, требующих обновления.</p>
            <div class="empty-actions">
                <a href="{{ url_for('batch_check') }}" class="btn-unified btn-info">
                    <i class="fas fa-sync-alt"></i> Проверить обновления
                </a>
                <a href="{{ url_for('devices') }}" class="btn-unified btn-outline">
                    <i class="fas fa-server"></i> Все устройства
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('batch_update') }}" id="updateForm">
            <input type="hidden" name="create_backup" value="true">
            
            <div class="table-container">
                <table class="table" id="devicesTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)" checked>
                            </th>
                            <th>Устройство</th>
                            <th>IP адрес</th>
                            <th>Статус</th>
                            <th>Версия RouterOS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr class="device-row" 
                            data-name="{{ device.name|lower }}" 
                            data-ip="{{ device.ip_address|lower }}"
                            data-status="{{ device.status }}"
                            data-last-check="{{ device.last_check.isoformat() if device.last_check else '' }}">
                            <td>
                                <div class="checkbox-container">
                                    <input type="checkbox" 
                                           name="device_ids" 
                                           value="{{ device.id }}" 
                                           class="device-checkbox" 
                                           data-status="{{ device.status }}"
                                           checked>
                                </div>
                            </td>
                            <td>
                                <div class="device-info-cell">
                                    <div class="device-details">
                                        <div class="device-name">
                                            {{ device.name }}
                                            <span class="update-indicator">
                                                <i class="fas fa-arrow-up"></i> Требует обновления
                                            </span>
                                        </div>
                                        {% if device.description %}
                                        <div class="device-description">
                                            {{ device.description|truncate(50) }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="device-address">
                                    <code>{{ device.ip_address }}:{{ device.port }}</code>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge {{ 'status-active' if device.status == 'online' else 'status-inactive' }}">
                                    {{ 'Онлайн' if device.status == 'online' else 'Офлайн' if device.status == 'offline' else 'Неизвестно' }}
                                </span>
                            </td>
                            <td>
                                <div class="device-version">
                                    {% if device.firmware_version %}
                                        <code>{{ device.firmware_version }}</code>
                                        <div class="version-outdated">
                                            <i class="fas fa-exclamation-triangle"></i> Устарела
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Неизвестно</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="update-settings mt-4 pt-4 border-top">
                <h6 class="settings-title">
                    <i class="fas fa-cog"></i> Настройки обновления
                </h6>
                
                <div class="settings-grid">
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-label">
                                <i class="fas fa-save"></i> Создание резервных копий
                            </div>
                            <div class="setting-switch">
                                <input type="checkbox" id="createBackup" name="create_backup" checked>
                                <label for="createBackup" class="switch"></label>
                            </div>
                        </div>
                        <div class="setting-description">
                            Рекомендуется включить для создания бекапа перед обновлением
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-label">
                                <i class="fas fa-redo"></i> Автоматическая перезагрузка
                            </div>
                            <div class="setting-switch">
                                <input type="checkbox" id="autoReboot" name="auto_reboot" checked>
                                <label for="autoReboot" class="switch"></label>
                            </div>
                        </div>
                        <div class="setting-description">
                            Автоматическая перезагрузка после установки обновлений
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-label">
                                <i class="fas fa-pause"></i> Задержка между устройствами
                            </div>
                            <div class="setting-value">
                                <input type="number" id="delayBetween" name="delay_between" value="30" min="10" max="300">
                                <span class="unit">секунд</span>
                            </div>
                        </div>
                        <div class="setting-description">
                            Задержка между обновлениями устройств (рекомендуется 30 сек)
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="confirmation-section mt-4 pt-4 border-top">
                <div class="confirmation-check">
                    <input type="checkbox" id="confirmUpdate" required>
                    <label for="confirmUpdate">
                        <i class="fas fa-check-circle"></i>
                        Я понимаю, что все выбранные устройства будут перезагружены и подтверждаю запуск массового обновления
                    </label>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* Предупреждение */
.warning-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--warning-color), #f3722c);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin-right: 15px;
}

.card-subtitle {
    color: var(--gray);
    font-size: 0.9rem;
    margin: 0;
}

.warning-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.warning-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(248, 150, 30, 0.05));
    border-radius: var(--border-radius);
    border-left: 4px solid var(--warning-color);
}

.warning-item i {
    font-size: 1.2rem;
    color: var(--warning-color);
    margin-top: 2px;
}

.warning-item strong {
    color: var(--dark-color);
    font-size: 1rem;
    display: block;
    margin-bottom: 5px;
}

.warning-item p {
    margin: 0;
    color: var(--gray);
    font-size: 0.9rem;
}

/* Статистика */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: var(--light-gray);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
}

.stat-icon.selected {
    background: linear-gradient(135deg, var(--warning-color), #f3722c);
}

.stat-icon.online {
    background: linear-gradient(135deg, var(--success-color), #4895ef);
}

.stat-icon.update {
    background: linear-gradient(135deg, #f72585, #b5179e);
}

.stat-icon.time {
    background: linear-gradient(135deg, var(--secondary-color), #560bad);
}

.stat-info h3 {
    margin: 0;
    font-size: 1.75rem;
    color: var(--dark-color);
}

.stat-info p {
    margin: 0;
    color: var(--gray);
    font-size: 0.9rem;
}

/* Таблица устройств */
.device-icon.warning {
    background: linear-gradient(135deg, var(--warning-color), #f3722c);
}

.device-info-cell {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.device-name {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 5px;
}

.update-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    background: rgba(248, 150, 30, 0.15);
    color: var(--warning-color);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 10px;
}

.update-indicator i {
    font-size: 0.7rem;
}

.device-description {
    font-size: 0.85rem;
    color: var(--gray);
    line-height: 1.3;
}

.device-address code {
    background: rgba(67, 97, 238, 0.1);
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-family: 'SF Mono', Consolas, Monaco, monospace;
}

.version-outdated {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.75rem;
    color: var(--warning-color);
    margin-top: 3px;
}

.version-outdated i {
    font-size: 0.7rem;
}

/* Дни с проверки */
.days-since-check {
    font-size: 0.85rem;
    font-weight: 500;
}

.recent-check {
    color: var(--success-color);
}

.old-check {
    color: var(--warning-color);
}

.very-old-check {
    color: var(--danger-color);
}

.never-checked {
    color: var(--gray);
}

/* Настройки обновления */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.setting-item {
    padding: 20px;
    background: var(--light-gray);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.setting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.setting-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: var(--dark-color);
}

.setting-label i {
    color: var(--primary-color);
    font-size: 0.9rem;
}

.setting-switch {
    display: flex;
    align-items: center;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.setting-switch input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    cursor: pointer;
}

.switch::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color);
    transition: .4s;
    border-radius: 24px;
}

.switch::after {
    content: "";
    position: absolute;
    cursor: pointer;
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,.2);
}

.setting-switch input[type="checkbox"]:checked + .switch::before {
    background-color: var(--primary-color);
}

.setting-switch input[type="checkbox"]:checked + .switch::after {
    transform: translateX(26px);
}

.setting-value {
    display: flex;
    align-items: center;
    gap: 8px;
}

.setting-value input {
    width: 70px;
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: var(--font-family);
    font-size: 14px;
    text-align: center;
}

.setting-value input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.unit {
    font-size: 0.85rem;
    color: var(--gray);
}

.setting-description {
    font-size: 0.85rem;
    color: var(--gray);
    line-height: 1.4;
}

/* Подтверждение */
.confirmation-check {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(248, 150, 30, 0.05));
    border-radius: var(--border-radius);
    border: 2px solid var(--warning-color);
}

.confirmation-check input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
}

.confirmation-check label {
    cursor: pointer;
    font-weight: 600;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.confirmation-check label i {
    color: var(--warning-color);
}

/* Адаптивность */
@media (max-width: 1200px) {
    .table-container {
        overflow-x: auto;
    }
    
    .table {
        min-width: 1000px;
    }
}

@media (max-width: 992px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .settings-grid {
        grid-template-columns: 1fr;
    }
    
    .selection-controls {
        flex-direction: column;
        width: 100%;
    }
    
    .selection-controls .btn-table {
        width: 100%;
        justify-content: center;
    }
    
    .card-header .d-flex {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .page-actions {
        flex-direction: column;
    }
    
    .page-actions .btn-unified {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .warning-item {
        flex-direction: column;
        gap: 10px;
    }
    
    .device-info-cell {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .device-icon {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    .stat-card {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .setting-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .confirmation-check label {
        font-size: 0.9rem;
    }
    
    .card-header, .card-body {
        padding: 15px;
    }
}

/* Пустое состояние */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    margin-bottom: 20px;
    color: var(--gray);
    opacity: 0.5;
}

.empty-state h5 {
    margin-bottom: 10px;
    color: var(--dark-gray);
}

.empty-state p {
    margin-bottom: 30px;
    color: var(--gray);
}

.empty-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedDevices = new Set();

function selectAll() {
    document.querySelectorAll('.device-checkbox').forEach(cb => {
        cb.checked = true;
        cb.closest('.device-row').classList.add('selected');
    });
    updateStats();
}

function deselectAll() {
    document.querySelectorAll('.device-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('.device-row').classList.remove('selected');
    });
    updateStats();
}

function selectOnline() {
    document.querySelectorAll('.device-checkbox').forEach(cb => {
        const isOnline = cb.getAttribute('data-status') === 'online';
        cb.checked = isOnline;
        if (isOnline) {
            cb.closest('.device-row').classList.add('selected');
            cb.closest('.device-row').classList.add('highlight');
        } else {
            cb.closest('.device-row').classList.remove('selected');
        }
    });
    updateStats();
}

function selectRecentlyChecked() {
    const now = new Date();
    document.querySelectorAll('.device-checkbox').forEach(cb => {
        const row = cb.closest('.device-row');
        const daysAgoElement = row.querySelector('.days-ago');
        const text = daysAgoElement ? daysAgoElement.textContent : '';
        const match = text.match(/(\d+)/);
        const daysAgo = match ? parseInt(match[1]) : 999;
        const isRecent = daysAgo < 7;
        
        cb.checked = isRecent;
        if (isRecent) {
            row.classList.add('selected');
            row.classList.add('highlight');
        } else {
            row.classList.remove('selected');
        }
    });
    updateStats();
}

function toggleAll(checkbox) {
    document.querySelectorAll('.device-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            cb.closest('.device-row').classList.add('selected');
        } else {
            cb.closest('.device-row').classList.remove('selected');
        }
    });
    updateStats();
}

function updateStats() {
    const checkboxes = document.querySelectorAll('.device-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    let onlineCount = 0;
    
    checkboxes.forEach(cb => {
        if (cb.getAttribute('data-status') === 'online') {
            onlineCount++;
        }
    });
    
    const selectedCountElement = document.getElementById('selectedCount');
    const onlineCountElement = document.getElementById('onlineCount');
    const selectedCountBadgeElement = document.getElementById('selectedCountBadge');
    
    if (selectedCountElement) selectedCountElement.textContent = selectedCount;
    if (onlineCountElement) onlineCountElement.textContent = onlineCount;
    if (selectedCountBadgeElement) selectedCountBadgeElement.textContent = selectedCount;
    
    const totalCheckboxes = document.querySelectorAll('.device-checkbox').length;
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        if (selectedCount === totalCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (selectedCount > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }
    
    const timeStatElement = document.querySelector('.stat-icon.time + .stat-info h3');
    if (timeStatElement) {
        const estimatedMinutes = Math.ceil(selectedCount * 5 + (selectedCount * 30 / 60)); // 5 минут на устройство + задержка
        timeStatElement.textContent = estimatedMinutes;
    }
}

function calculateDaysSinceCheck() {
    const now = new Date();
    document.querySelectorAll('.days-ago').forEach(element => {
        const lastCheckISO = element.getAttribute('data-last-check');
        if (lastCheckISO) {
            try {
                const lastCheck = new Date(lastCheckISO);
                const diffTime = Math.abs(now - lastCheck);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                element.textContent = diffDays + ' д.';
                

                element.className = 'days-ago';
                if (diffDays < 1) {
                    element.classList.add('recent-check');
                } else if (diffDays < 7) {
                    element.classList.add('recent-check');
                } else if (diffDays < 30) {
                    element.classList.add('old-check');
                } else {
                    element.classList.add('very-old-check');
                }
            } catch (e) {
                console.error('Error parsing date:', lastCheckISO, e);
                element.textContent = 'Ошибка';
                element.classList.add('never-checked');
            }
        } else {
            element.textContent = 'Никогда';
            element.classList.add('never-checked');
        }
    });
}


document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('deviceSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.device-row');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const ip = row.getAttribute('data-ip');
                
                if (name.includes(searchTerm) || ip.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    

    const checkboxes = document.querySelectorAll('.device-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            if (this.checked) {
                this.closest('.device-row').classList.add('selected');
                this.closest('.device-row').classList.add('highlight');
            } else {
                this.closest('.device-row').classList.remove('selected');
            }
            updateStats();
        });
        

        cb.addEventListener('change', function() {
            const row = this.closest('.device-row');
            if (row.classList.contains('highlight')) {
                setTimeout(() => {
                    row.classList.remove('highlight');
                }, 1500);
            }
        });
    });
    

    let initialOnlineCount = 0;
    checkboxes.forEach(cb => {
        if (cb.getAttribute('data-status') === 'online') {
            initialOnlineCount++;
        }
    });
    const onlineCountElement = document.getElementById('onlineCount');
    if (onlineCountElement) onlineCountElement.textContent = initialOnlineCount;
    

    const rows = document.querySelectorAll('.device-row');
    rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
    });
    

    if (searchInput) {
        searchInput.focus();
    }
    

    calculateDaysSinceCheck();
    

    const form = document.getElementById('updateForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const selectedCount = document.querySelectorAll('.device-checkbox:checked').length;
            if (selectedCount === 0) {
                e.preventDefault();
                showNotification('Пожалуйста, выберите хотя бы одно устройство для обновления', 'warning');
                return false;
            }
            
            const confirmUpdate = document.getElementById('confirmUpdate');
            if (!confirmUpdate.checked) {
                e.preventDefault();
                showNotification('Пожалуйста, подтвердите запуск массового обновления', 'warning');
                confirmUpdate.focus();
                return false;
            }
            
            const createBackup = document.getElementById('createBackup').checked;
            const warningMessage = `Вы собираетесь обновить ${selectedCount} устройств.\n\n` +
                                 `• Устройства будут ${createBackup ? 'обновлены с созданием бекапа' : 'обновлены без бекапа'}\n` +
                                 `• Все устройства будут перезагружены\n` +
                                 `• Сетевое соединение прервется на несколько минут\n\n` +
                                 `Вы уверены, что хотите продолжить?`;
            
            if (!confirm(warningMessage)) {
                e.preventDefault();
                return false;
            }
            

            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Подготовка обновления...';
                submitButton.disabled = true;
            }
        });
    }
    
    updateStats();
});


function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `flash-message flash-${type}`;
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        ${message}
        <button class="flash-close">&times;</button>
    `;
    
    const container = document.querySelector('.flash-container');
    if (!container) {
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            const newContainer = document.createElement('div');
            newContainer.className = 'flash-container';
            mainContent.insertBefore(newContainer, mainContent.firstChild);
            newContainer.appendChild(notification);
        }
    } else {
        container.appendChild(notification);
    }
    
    notification.querySelector('.flash-close').addEventListener('click', function() {
        this.parentElement.style.opacity = '0';
        setTimeout(() => {
            if (this.parentElement && this.parentElement.parentElement) {
                this.parentElement.parentElement.removeChild(this.parentElement);
            }
        }, 300);
    });
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}
</script>
{% endblock %}